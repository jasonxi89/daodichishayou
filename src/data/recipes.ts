export interface Recipe {
  name: string
  summary: string
  ingredients: string[]
  steps: string[]
}

const recipes: Record<string, Recipe> = {
  '番茄炒蛋': {
    name: '番茄炒蛋',
    summary: '家常第一菜，酸甜下饭，10分钟搞定',
    ingredients: ['番茄 2个', '鸡蛋 3个', '葱花 适量', '盐 适量', '糖 1小勺', '食用油 适量'],
    steps: [
      '番茄切块，鸡蛋打散加少许盐搅匀',
      '锅中倒油烧热，倒入蛋液，凝固后划散盛出',
      '锅中再加少许油，放入番茄块翻炒出汁',
      '加入盐和糖调味，倒回炒蛋翻匀',
      '撒上葱花即可出锅',
    ],
  },
  '红烧肉': {
    name: '红烧肉',
    summary: '肥而不腻、入口即化的经典硬菜',
    ingredients: ['五花肉 500g', '冰糖 30g', '生抽 2勺', '老抽 1勺', '料酒 2勺', '姜片 3片', '八角 2个', '桂皮 1小块', '葱段 适量'],
    steps: [
      '五花肉切块，冷水下锅焯水去血沫，捞出备用',
      '锅中放少许油，加冰糖小火炒至枣红色',
      '放入五花肉翻炒上色',
      '加入姜片、八角、桂皮、葱段炒香',
      '倒入料酒、生抽、老抽翻匀',
      '加热水没过肉面，大火烧开后转小火炖40分钟',
      '大火收汁至浓稠即可',
    ],
  },
  '宫保鸡丁': {
    name: '宫保鸡丁',
    summary: '香辣微甜，花生酥脆，经典川菜',
    ingredients: ['鸡胸肉 300g', '花生米 50g', '干辣椒 6个', '花椒 1小勺', '葱白 2段', '蒜 3瓣', '姜 2片', '生抽 1勺', '醋 1勺', '糖 1勺', '淀粉 1勺', '料酒 1勺'],
    steps: [
      '鸡胸肉切丁，加料酒、生抽、淀粉腌制15分钟',
      '花生米炸至金黄备用',
      '调碗汁：生抽、醋、糖、淀粉、少许水拌匀',
      '锅中油热，放花椒、干辣椒炒出香味',
      '放入鸡丁大火翻炒至变色',
      '加入葱姜蒜炒香',
      '倒入碗汁快速翻炒均匀',
      '最后放入花生米翻拌出锅',
    ],
  },
  '麻婆豆腐': {
    name: '麻婆豆腐',
    summary: '麻辣鲜香，豆腐嫩滑，米饭杀手',
    ingredients: ['嫩豆腐 1块', '猪肉末 100g', '郫县豆瓣酱 1勺', '花椒粉 适量', '蒜末 适量', '葱花 适量', '生抽 1勺', '淀粉水 适量'],
    steps: [
      '豆腐切小块，开水焯1分钟捞出沥水',
      '锅中倒油，放入肉末炒散至变色',
      '加入豆瓣酱炒出红油，放蒜末炒香',
      '加适量水烧开，放入豆腐轻推（不要翻炒）',
      '加生抽调味，小火煮3分钟入味',
      '淋入淀粉水勾芡',
      '撒花椒粉和葱花出锅',
    ],
  },
  '糖醋排骨': {
    name: '糖醋排骨',
    summary: '酸甜可口，色泽红亮，老少皆宜',
    ingredients: ['小排 500g', '料酒 2勺', '生抽 2勺', '醋 3勺', '糖 3勺', '番茄酱 1勺', '姜片 3片', '白芝麻 适量'],
    steps: [
      '排骨冷水下锅焯水，捞出洗净',
      '锅中倒油，放入排骨煎至两面金黄',
      '加入姜片、料酒、生抽翻炒',
      '加热水没过排骨，大火烧开转小火炖20分钟',
      '加入醋、糖、番茄酱调味',
      '大火收汁至浓稠包裹排骨',
      '撒上白芝麻出锅',
    ],
  },
  '鱼香肉丝': {
    name: '鱼香肉丝',
    summary: '酸甜辣鲜，无鱼胜有鱼的经典川味',
    ingredients: ['猪肉 250g', '胡萝卜 1根', '木耳 适量', '青椒 1个', '泡椒 3个', '蒜末 适量', '姜末 适量', '葱花 适量', '生抽 1勺', '醋 1勺', '糖 1勺', '淀粉 适量'],
    steps: [
      '猪肉切丝，加料酒、淀粉抓匀腌制',
      '胡萝卜、木耳、青椒切丝备用',
      '调碗汁：生抽、醋、糖、淀粉、水拌匀',
      '锅中油热，放入肉丝炒散至变色盛出',
      '锅中放泡椒、姜蒜末炒出红油',
      '放入胡萝卜丝、木耳丝翻炒',
      '倒回肉丝，加入碗汁快速翻匀',
      '撒葱花出锅',
    ],
  },
  '回锅肉': {
    name: '回锅肉',
    summary: '蒜苗飘香、肉片灯盏窝的川菜之王',
    ingredients: ['五花肉 400g', '蒜苗 3根', '青椒 2个', '郫县豆瓣酱 1.5勺', '豆豉 1勺', '生抽 1勺', '料酒 1勺', '姜 3片', '花椒 几粒'],
    steps: [
      '五花肉整块冷水下锅，加姜片、花椒、料酒煮至筷子能插透，捞出放凉',
      '切成薄片，蒜苗斜切段，青椒切片',
      '锅中不放油，放入肉片煎至微卷出油',
      '推到一边，放入豆瓣酱和豆豉炒出红油',
      '翻匀肉片上色，加少许生抽',
      '放入青椒和蒜苗大火翻炒至断生出锅',
    ],
  },
  '水煮鱼': {
    name: '水煮鱼',
    summary: '麻辣鲜嫩、鱼片滑嫩的川菜名菜',
    ingredients: ['草鱼 1条', '豆芽 200g', '干辣椒 15个', '花椒 2勺', '蒜末 适量', '郫县豆瓣酱 1勺', '料酒 1勺', '蛋清 1个', '淀粉 1勺', '生抽 适量'],
    steps: [
      '鱼片取鱼骨分开，鱼片加蛋清、淀粉、料酒腌制',
      '豆芽焯水铺在碗底',
      '锅中炒香豆瓣酱，加水烧开',
      '先放鱼骨煮5分钟，再放鱼片滑散煮至变色',
      '连汤倒在豆芽上',
      '另起锅，油烧至冒烟，放干辣椒和花椒炸香',
      '将热油浇在鱼片上，撒蒜末即成',
    ],
  },
  '酸菜鱼': {
    name: '酸菜鱼',
    summary: '酸辣开胃，鱼片鲜嫩，汤底浓郁',
    ingredients: ['草鱼 1条', '酸菜 200g', '泡椒 5个', '蒜 4瓣', '姜 3片', '蛋清 1个', '淀粉 1勺', '料酒 1勺', '花椒 适量', '白胡椒粉 适量'],
    steps: [
      '鱼片切薄片，加蛋清、淀粉、料酒腌制15分钟',
      '酸菜切段，挤干水分',
      '锅中倒油，炒香花椒、泡椒、姜蒜',
      '加入酸菜翻炒出香味',
      '加入开水和鱼骨，大火煮10分钟',
      '捞出鱼骨，下鱼片轻轻搅散，煮1分钟至熟',
      '加白胡椒粉调味，出锅撒葱花',
    ],
  },
  '蛋炒饭': {
    name: '蛋炒饭',
    summary: '粒粒分明、蛋香浓郁的快手主食',
    ingredients: ['隔夜米饭 1碗', '鸡蛋 2个', '葱花 适量', '盐 适量', '食用油 适量'],
    steps: [
      '鸡蛋打散，米饭提前拨散',
      '锅中多倒些油烧至冒烟',
      '倒入蛋液，趁未完全凝固立刻倒入米饭',
      '大火快速翻炒，使蛋液包裹每粒饭',
      '加盐调味，撒葱花翻匀出锅',
    ],
  },
  '火锅': {
    name: '火锅',
    summary: '万能社交餐，自选食材涮着吃',
    ingredients: ['火锅底料 1包', '毛肚 适量', '肥牛卷 适量', '豆腐 适量', '生菜 适量', '土豆片 适量', '藕片 适量', '粉丝 适量', '蒜泥 适量', '香油 适量', '蚝油 适量'],
    steps: [
      '锅中加水烧开，放入火锅底料化开',
      '准备蘸料：蒜泥+香油+蚝油+葱花搅匀',
      '先涮不易熟的：土豆片、藕片、豆腐',
      '再涮毛肚（七上八下，15秒左右）',
      '肥牛卷涮至变色即可',
      '最后涮蔬菜和粉丝',
    ],
  },
  '小龙虾': {
    name: '小龙虾',
    summary: '蒜蓉/麻辣任选，夏夜标配',
    ingredients: ['小龙虾 2斤', '蒜 2头', '干辣椒 10个', '花椒 1勺', '姜 4片', '啤酒 1罐', '生抽 2勺', '糖 1勺', '葱段 适量'],
    steps: [
      '小龙虾刷洗干净，去虾线',
      '锅中多倒油，放花椒、干辣椒、姜片炒香',
      '倒入小龙虾大火翻炒至变红',
      '加入蒜末（留一半最后放）、生抽、糖翻匀',
      '倒入啤酒没过虾身，大火烧开转中火焖10分钟',
      '大火收汁，撒剩余蒜末和葱段出锅',
    ],
  },
  '炸鸡': {
    name: '炸鸡',
    summary: '外酥里嫩、金黄诱人的经典美味',
    ingredients: ['鸡腿/鸡翅 500g', '面粉 100g', '淀粉 50g', '鸡蛋 1个', '盐 适量', '黑胡椒 适量', '料酒 1勺', '蒜粉 适量', '食用油 适量'],
    steps: [
      '鸡肉加盐、黑胡椒、料酒、蒜粉腌制2小时以上',
      '面粉和淀粉混合，鸡蛋打散备用',
      '鸡肉裹面粉→蘸蛋液→再裹面粉',
      '油温170°C，放入鸡肉炸5分钟至金黄捞出',
      '油温升至190°C，复炸1分钟至酥脆',
    ],
  },
  '鸡胸肉沙拉': {
    name: '鸡胸肉沙拉',
    summary: '高蛋白低脂，健身减脂首选',
    ingredients: ['鸡胸肉 200g', '生菜 适量', '小番茄 6个', '黄瓜 半根', '玉米粒 适量', '橄榄油 1勺', '柠檬汁 1勺', '黑胡椒 适量', '盐 少许'],
    steps: [
      '鸡胸肉加盐和黑胡椒腌制，煎熟后切片',
      '生菜撕小块，黄瓜切片，小番茄对半切',
      '所有蔬菜铺盘，摆上鸡肉片和玉米粒',
      '淋上橄榄油和柠檬汁拌匀即可',
    ],
  },
  '清蒸鱼': {
    name: '清蒸鱼',
    summary: '鲜嫩原味，简单健康的广式经典',
    ingredients: ['鲈鱼 1条', '葱丝 适量', '姜丝 适量', '蒸鱼豉油 2勺', '料酒 1勺', '食用油 适量'],
    steps: [
      '鱼处理干净，两面划刀，抹料酒和少许盐',
      '鱼身铺上姜丝，水烧开后上锅蒸8-10分钟',
      '倒掉盘中蒸出的汤汁',
      '铺上新鲜葱丝，淋上蒸鱼豉油',
      '烧一勺热油浇在葱丝上，滋啦一声即成',
    ],
  },
  '披萨': {
    name: '披萨',
    summary: '芝士拉丝、料足味美的烤箱美食',
    ingredients: ['披萨饼皮 1张', '马苏里拉芝士 200g', '番茄酱 3勺', '培根/火腿 适量', '青椒 半个', '洋葱 半个', '蘑菇 适量', '橄榄油 少许'],
    steps: [
      '饼皮涂抹番茄酱，留1cm边缘',
      '撒一层芝士打底',
      '铺上培根、青椒、洋葱、蘑菇等配料',
      '再撒厚厚一层芝士',
      '烤箱预热220°C，烤12-15分钟至芝士融化起泡',
    ],
  },
  '麻辣烫': {
    name: '麻辣烫',
    summary: '自选食材一锅煮，麻辣鲜香',
    ingredients: ['麻辣烫底料 适量', '各种蔬菜 适量', '丸子 适量', '豆皮 适量', '粉丝 适量', '火腿肠 适量', '芝麻酱 适量'],
    steps: [
      '锅中加水烧开，加入麻辣烫底料煮化',
      '先放不易熟的食材：土豆、藕片、豆皮',
      '再放丸子、火腿肠煮3分钟',
      '最后放蔬菜和粉丝煮2分钟',
      '捞出装碗，淋芝麻酱拌匀',
    ],
  },
  '烤鸭': {
    name: '烤鸭',
    summary: '皮脆肉嫩，卷饼蘸酱的经典吃法',
    ingredients: ['鸭子 1只', '蜂蜜 2勺', '五香粉 适量', '盐 适量', '甜面酱 适量', '葱丝 适量', '黄瓜条 适量', '薄饼 适量'],
    steps: [
      '鸭子处理干净，腔内抹五香粉和盐',
      '外皮刷蜂蜜水，晾干（重复2-3次）',
      '烤箱200°C烤1小时，中间翻面刷蜂蜜水',
      '烤好后切片',
      '薄饼抹甜面酱，放鸭肉片、葱丝、黄瓜条卷起食用',
    ],
  },
  '自制豆腐': {
    name: '自制豆腐',
    summary: '简单家常的煎豆腐/豆腐汤做法',
    ingredients: ['老豆腐 1块', '葱花 适量', '蒜末 适量', '生抽 1勺', '蚝油 半勺', '盐 适量', '食用油 适量'],
    steps: [
      '豆腐切成1cm厚的方块',
      '锅中倒油烧热，放入豆腐煎至两面金黄',
      '加入蒜末炒香',
      '淋入生抽和蚝油，加少许水焖2分钟',
      '撒葱花出锅',
    ],
  },
  '黄焖鸡': {
    name: '黄焖鸡',
    summary: '酱香浓郁、鸡肉滑嫩的拌饭神器',
    ingredients: ['鸡腿肉 400g', '香菇 6朵', '青椒 2个', '姜 3片', '蒜 3瓣', '生抽 2勺', '老抽 1勺', '蚝油 1勺', '料酒 1勺', '黄焖酱 1勺'],
    steps: [
      '鸡腿肉切块，冷水焯水捞出',
      '锅中放油，放姜蒜炒香',
      '加入鸡块翻炒至微黄',
      '加料酒、生抽、老抽、蚝油、黄焖酱翻匀',
      '放入香菇，加热水没过鸡肉',
      '大火烧开转小火焖20分钟',
      '加入青椒翻匀，大火收汁',
    ],
  },
}

// API 缓存
const apiCache: Record<string, Recipe> = {}

export function getLocalRecipe(name: string): Recipe | null {
  return recipes[name] || null
}

export async function fetchRecipeFromAPI(name: string): Promise<Recipe | null> {
  // 先查缓存
  if (apiCache[name]) return apiCache[name]

  try {
    const Taro = (await import('@tarojs/taro')).default
    const res = await Taro.request({
      url: 'https://apis.tianapi.com/caipu/index',
      method: 'GET',
      data: {
        key: '8fe628ae496e3e8e63fa4067c01e4a4a',
        word: name,
        num: 1,
      },
    })
    if (res.data?.code === 200 && res.data?.result?.list?.length) {
      const item = res.data.result.list[0]

      // 解析食材：统一去编号，按分号/编号/换行拆分
      const rawIngredients = [item.yuanliao, item.tiaoliao].filter(Boolean).join('；')
      const ingredients = rawIngredients
        .split(/[;；\n]|\d+[、.)\]]\s*/)
        .map((s: string) => s.replace(/^\s*[（(].*?[）)]\s*/, '').trim())
        .filter((s) => s.length > 0)

      // 解析步骤：按编号拆分，清理尾部杂项和空白
      let steps: string[] = ['暂无步骤信息']
      if (item.zuofa) {
        const raw = item.zuofa.replace(/\r/g, '').trim()
        const parts = raw.split(/\d+[.、)\]]\s*/).filter(Boolean)
        steps = parts
          .map((s: string) => s.replace(/\s*具体操作[：:]?[\s\S]*$/, '').replace(/[；;]\s*$/, '').trim())
          .filter((s) => s.length > 0)
      }

      // 摘要：优先 texing，其次 tishi，兜底生成
      let summary = (item.texing || item.tishi || '').trim()
      if (!summary && steps.length > 0) {
        summary = steps[0].substring(0, 30) + (steps[0].length > 30 ? '...' : '')
      }
      if (!summary) summary = `${name}的做法`

      const recipe: Recipe = {
        name: item.cp_name || name,
        summary,
        ingredients: ingredients.length > 0 ? ingredients : ['暂无食材信息'],
        steps,
      }
      apiCache[name] = recipe
      return recipe
    }
  } catch {
    // API 调用失败，返回 null
  }
  return null
}

export default recipes
